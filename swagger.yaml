openapi: 3.0.3
info:
  title: Bookstore API
  version: 1.0.0
  description: >
    API for querying Project Gutenberg books using multiple filters,
    pagination, and sorting by popularity (download_count).

servers:
  - url: http://127.0.0.1:8000/api
    description: Local development server (use for local Swagger Editor)
  - url: https://<your-ngrok-id>.ngrok.io
    description: ngrok HTTPS tunnel (replace <your-ngrok-id> with actual id)

tags:
  - name: Books
    description: Endpoints to search and list Project Gutenberg books

paths:
  /books:
    get:
      tags:
        - Books
      summary: List books with filters
      description: >
        Returns a paginated list of books matching the given filters.
        Supports multiple values per filter via CSV (comma-separated values).
        Results are sorted by download_count in descending order.
      parameters:
        - name: ids
          in: query
          description: >
            Comma-separated list of Gutenberg book IDs. Example: ids=11,12,13
          required: false
          schema:
            type: string
            example: "11,12,13"

        - name: language
          in: query
          description: >
            Comma-separated list of language codes. Example: language=en,fr
          required: false
          schema:
            type: string
            example: "en,fr"

        - name: mime_type
          in: query
          description: >
            Comma-separated MIME type prefixes. Example: mime_type=text/,application/pdf
          required: false
          schema:
            type: string
            example: "text/,application/pdf"

        - name: topic
          in: query
          description: >
            Comma-separated keywords checked (case-insensitive) against subjects and bookshelves.
            Example: topic=child,infant
          required: false
          schema:
            type: string
            example: "child,infant"

        - name: author
          in: query
          description: >
            Comma-separated partial author name matches.
            Example: author=austen,dickens
          required: false
          schema:
            type: string
            example: "austen,dickens"

        - name: title
          in: query
          description: >
            Comma-separated partial book title matches.
            Example: title=pride,war
          required: false
          schema:
            type: string
            example: "pride,war"

        - name: page
          in: query
          description: >
            Page number (1-based index)
          required: false
          schema:
            type: integer
            minimum: 1
            default: 1
            example: 1

        - name: page_size
          in: query
          description: >
            Page size (maximum allowed = 25)
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 25
            default: 25
            example: 25

      responses:
        '200':
          description: Paginated list of books
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BookListResponse'
              example:
                total: 1500
                page: 1
                page_size: 25
                results:
                  - id: 1342
                    title: "Pride and Prejudice"
                    genre: "Best Books Ever Listings"
                    authors:
                      - "Austen, Jane"
                    languages:
                      - "en"
                    subjects:
                      - "Courtship -- Fiction"
                      - "Young women -- Fiction"
                    bookshelves:
                      - "Best Books Ever Listings"
                    download_count: 12345
                    formats:
                      - mime_type: "text/html; charset=utf-8"
                        url: "https://www.gutenberg.org/ebooks/1342.html.images"
                      - mime_type: "application/pdf"
                        url: "https://www.gutenberg.org/ebooks/1342.pdf"
        '400':
          $ref: '#/components/responses/BadRequest'
        '422':
          $ref: '#/components/responses/ValidationError'
        '500':
          $ref: '#/components/responses/InternalServerError'

components:
  responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            message: "Malformed request"
    ValidationError:
      description: Validation failed
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ValidationErrorResponse'
          example:
            message: "Validation failed"
            errors:
              page:
                - "page must be >= 1"
              page_size:
                - "page_size must be <= 25"
    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            message: "An unexpected error occurred"

  schemas:
    Error:
      type: object
      properties:
        message:
          type: string
      required:
        - message

    ValidationErrorResponse:
      type: object
      properties:
        message:
          type: string
        errors:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
      required:
        - message
        - errors

    BookFormat:
      type: object
      properties:
        mime_type:
          type: string
          example: "text/html; charset=utf-8"
        url:
          type: string
          format: uri
          example: "https://www.gutenberg.org/ebooks/1342.html.images"
      required:
        - mime_type
        - url

    Book:
      type: object
      required:
        - id
        - title
        - download_count
      properties:
        id:
          type: integer
          example: 1342
        title:
          type: string
          example: "Pride and Prejudice"
        genre:
          type: string
          nullable: true
          example: "Best Books Ever Listings"
        authors:
          type: array
          items:
            type: string
          example:
            - "Austen, Jane"
        languages:
          type: array
          items:
            type: string
          example:
            - "en"
        subjects:
          type: array
          items:
            type: string
          example:
            - "Courtship -- Fiction"
        bookshelves:
          type: array
          items:
            type: string
          example:
            - "Best Books Ever Listings"
        download_count:
          type: integer
          example: 12345
        formats:
          type: array
          items:
            $ref: '#/components/schemas/BookFormat'

    BookListResponse:
      type: object
      properties:
        total:
          type: integer
          example: 1500
        page:
          type: integer
          example: 1
        page_size:
          type: integer
          example: 25
        results:
          type: array
          items:
            $ref: '#/components/schemas/Book'

security: []
